# TODO

debug的部分：P0
	1. 预测出的id不对。
		- 原因可能是用离线的datasource_id训练的；需要校验和测试环境、线上环境读取的datasource_id是否一致。
		- 另一个原因是使用了datasource_id(int形式的) 作为输入的feature. 但模型处理feature的时候有一个映射转换，是根据训练集中出现这个feature的值的顺序来决定的。这会导致混乱。

	2. 预测的时间窗口总数不对。因为datasource的数量会影响生成的预测数据点的数量。需要对数量进行校验。

需要重构的部分：P1
	1. 流程：
		- 从启动环节、预测环节、配置更新环节、发送请求环节 四块重新梳理当前代码。现在自己读着都费劲。
	
	2. 机器学习模型：	
		- feature处理：流程比较混乱，需要保证feature映射前后是可以和数据库保持对应的，最好是高可读的，不然不好debug.
		- 大量使用了dataframe，有些地方设计的可读性比较低（例如status_matrix）。
		- 模型管理：模型训练、读取等现在比较草台班子。后面可能会经常更新模型，而且同步会更新feature映射。需要清晰可知当前模型的一些meta信息。例如更新的版本、更新时的数据源总数等。

需要补充的功能：P0
	1. 蹲饼策略：
		- 兜底蹲饼策略、其他人为自定义设计的策略的实现。
		- 上面的各种蹲饼策略，和机器学习蹲饼策略质检，应该是并行的、非阻塞的。

################
询问了一下deepseek，规则系统如何和ml模型相结合。有一定的道理。

#### 方案对比表
| 维度                | 预计算模式                          | 实时计算模式                        | 混合模式（推荐）                  |
|---------------------|-----------------------------------|-----------------------------------|---------------------------------|
| **计算时机**         | 预测时一次性计算全天决策            | 到达每个时间点时动态计算            | 静态规则预计算 + 动态规则实时处理 |
| **数据时效性**       | 依赖预测数据的准确性                | 可结合实时数据调整                  | 平衡静态与动态数据               |
| **计算复杂度**       | O(n) 一次性计算                    | O(1) 分时计算                     | 分层次复杂度管理                 |
| **内存消耗**         | 需要存储全天决策                    | 仅需缓存当前时段数据                | 部分预存 + 动态加载              |
| **规则更新影响**     | 需要重新生成全天决策                | 立即生效                          | 按规则类型区分处理               |
| **典型适用场景**     | 确定性规则（如时间窗口）            | 含实时变量的规则（如当前系统负载）   | 大部分业务场景                   |

#### 推荐方案：混合生效模式
1. **预计算层**（静态规则）
   - 处理确定性的时间窗口规则
   - 每日预测时生成 `precomputed_actions` 表
   ```python
   # 预计算数据表示例
   {
       "user_id": "A",
       "trigger_time": "08:00:00",
       "valid_windows": [
           {"start": "07:59:50", "end": "08:00:10"},
           {"start": "20:00:00", "end": "23:59:59"}
       ]
   }
   ```

2. **实时计算层**（动态规则）
   - 处理需要运行时计算的规则
   - 频率控制、系统状态依赖等规则

################
* 基本框架，接受轮询请求，对单个蹲饼器，返回 updated ttl
* (测试用) 蹲饼器，可发请求
* 蹲饼器注册框架，对多个蹲饼器，分别管理状态
* 更新蹲饼器策略, 根据当前各蹲饼器状态，重新分配蹲饼方法.(这里和蹲饼器对齐如何分配.)


* https://github.com/Enraged-Dun-Cookie-Development-Team/cookie-fetcher/tree/master/src/extend
config 对应json5的配置，要保留修改空间.  
* mysql里有interval 是单独配置的；其他字段是config里面序列化了.
* 直接内存.
* 如果warning了就去数据库取config.
* 2022-12-23 10:15:14
    - 引入数据库组件；暂不引入ORM.
    - 写一个get的接口，只要被请求了，就更新结果.
 